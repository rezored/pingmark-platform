<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pingmark™: A Protocol for Universal Spatial Mentions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        #map {
            height: 420px;
            width: 100%;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }

        .code-block {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            overflow-x: auto;
        }

        .pingmark-logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 2.25rem;
            font-weight: 900;
            line-height: 1;
        }

        .logo-pin {
            fill: #ef4444;
            width: 3rem;
            height: 3rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

<div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-4">
        <div></div>
        <div class="flex">
            <button id="lang-en" class="px-3 py-1 text-sm rounded-l-lg font-semibold border border-red-500 bg-red-500 text-white transition" onclick="switchLanguage('en')">English</button>
            <button id="lang-bg" class="px-3 py-1 text-sm rounded-r-lg font-semibold border border-gray-300 text-gray-600 hover:bg-gray-100 transition" onclick="switchLanguage('bg')">Български</button>
        </div>
    </div>

    <header class="text-center mb-10">
        <h1 class="text-5xl font-extrabold text-gray-900 mb-2 flex items-center justify-center">
            <div class="pingmark-logo">
                <svg class="logo-pin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C8.686 2 6 4.686 6 8c0 4.5 6 14 6 14s6-9.5 6-14c0-3.314-2.686-6-6-6z" fill="#EF4444"></path>
                    <circle cx="12" cy="8" r="3" fill="#FEE2E2"></circle>
                    <text x="12" y="10" font-family="Inter, sans-serif" font-size="6" font-weight="900" text-anchor="middle" fill="#1F2937">!@</text>
                </svg>
                <span id="header-title" class="text-4xl text-gray-900 ml-1">Pingmark™</span>
            </div>
        </h1>
        <p id="header-subtitle" class="text-xl text-gray-600 mt-4">A Universal Textual Protocol for Spatial Mentions (PPS v0.1)</p>
    </header>

    <section class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl mb-12 border border-gray-100">
        <h2 id="resolver-title" class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3 text-red-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"/>
            </svg>
            Reference Resolver: Map Viewer
        </h2>
<div>
    <a href="https://pingmark.me/43.083900/25.655200/2025-10-14T19:18:42.470Z">https://pingmark.me/43.083900/25.655200/2025-10-14T19:18:42.470Z</a>
</div>
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
            <input id="pm-text" class="flex-1 border rounded-lg px-3 py-2" placeholder="Paste text with a pingmark (e.g., !@ 42.6977,23.3219; 2025-10-14T12:00:00Z)"/>
            <div class="flex gap-2">
                <button id="btn-resolve" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Resolve</button>
                <button id="btn-use-location" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Use my location</button>
            </div>
        </div>
        <div id="status" class="text-sm text-gray-600 mb-4"></div>

        <div id="map"></div>

        <div class="mt-6 text-center p-4 rounded-xl border border-red-300 bg-red-50 shadow-inner">
            <p id="location-info" class="text-gray-700 font-medium text-sm sm:text-base">
                To view a location, append parameters to the URL, e.g., <span class="font-mono text-sm block sm:inline font-semibold">/42.6977/23.3219</span>
            </p>
        </div>

        <div id="action-buttons" class="mt-8 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 justify-center" style="display: none;">
            <a id="maps-link" target="_blank" class="px-8 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300 shadow-md hover:shadow-lg text-center">Open in Google Maps</a>
            <a id="osrm-link" target="_blank" class="px-8 py-3 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-800 transition duration-300 shadow-md hover:shadow-lg text-center">Get Directions (OSRM)</a>
            <button id="btn-copy" class="px-6 py-3 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Copy share link</button>
        </div>
    </section>

    <section class="mb-16">
        <h2 id="syntax-title" class="text-3xl font-bold text-gray-900 mb-8 text-center">How Pingmark™ Works</h2>
        <div class="space-y-6 text-lg text-gray-700 mb-8">
            <p id="explanation-p1" class="text-center max-w-2xl mx-auto">
                Pingmark™ defines a minimal protocol (<strong>PPS v0.1</strong>) that transforms location from a complex "feature" into a <strong>simple textual element</strong>. Similar to <code class="font-mono">@</code> for usernames and <code class="font-mono">#</code> for hashtags, <strong>!@</strong> is the universal token for physical space.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
            <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition border border-gray-200">
                <div class="text-red-500 mb-4 mx-auto w-12 h-12">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 20.25H8.625v-1.957l8.237-8.238Z"/>
                    </svg>
                </div>
                <h3 id="flow-h3-1" class="text-xl font-semibold text-gray-800 mb-2">1. The Text Trigger</h3>
                <p id="flow-p1" class="text-gray-600 text-sm">User types the trigger: <code class="font-mono font-semibold">"I am at <strong>!@</strong>"</code> in any app or text field.</p>
            </div>

            <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition border border-gray-200">
                <div class="text-red-500 mb-4 mx-auto w-12 h-12">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"/>
                    </svg>
                </div>
                <h3 id="flow-h3-2" class="text-xl font-semibold text-gray-800 mb-2">2. Local Coordinate Generation</h3>
                <p id="flow-p2" class="text-gray-600 text-sm">The client (L1 Parser) uses the device's GPS to silently grab <code class='font-mono font-semibold'>/Lat/Lon</code>.</p>
            </div>

            <div class="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition border border-gray-200">
                <div class="text-red-500 mb-4 mx-auto w-12 h-12">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.241-1.241m5.253-3.671L15.81 8.24m5.253 3.671-3.671-5.253M12 21.75V15.75m0-6V3.75"/>
                    </svg>
                </div>
                <h3 id="flow-h3-3" class="text-xl font-semibold text-gray-800 mb-2">3. The Resolver Link</h3>
                <p id="flow-p3" class="text-gray-600 text-sm">The final, shareable, and open URL is generated: <code class='font-mono text-xs font-semibold'>pingmark.me/Lat/Lon/...</code></p>
            </div>
        </div>

        <div class="mt-8 p-5 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg max-w-3xl mx-auto">
            <p id="explanation-key" class="font-semibold text-yellow-800 text-base">
                <strong>Crucially:</strong> <strong>!@</strong> never contains coordinates. They are generated <strong>locally</strong> by your client application (e.g., keyboard or browser extension) and embedded into a standardized, open URL.
            </p>
        </div>
    </section>

    <section class="bg-gray-100 p-6 sm:p-8 rounded-xl mb-16">
        <h2 id="structure-title" class="text-3xl font-bold text-gray-900 mb-6">Protocol Structure (PPS v0.1)</h2>
        <div class="space-y-4">
            <h3 class="text-xl font-semibold text-gray-800">Standard Resolver Link</h3>
            <div class="code-block"><code class="font-mono">https://pingmark.me/&lt;latitude&gt;/&lt;longitude&gt;[/&lt;timestamp&gt;]</code></div>
            <ul class="list-disc list-inside text-gray-700 ml-4">
                <li id="syntax-li-1"><code class="font-mono">latitude/longitude</code>: Generated locally by the device's GPS.</li>
                <li id="syntax-li-2"><code class="font-mono">[timestamp]</code>: Optional (ISO 8601), indicating the ephemerality of the location.</li>
            </ul>
        </div>
    </section>

    <section class="text-center p-8 bg-red-600 text-white rounded-xl shadow-2xl">
        <h2 id="open-title" class="text-3xl font-bold mb-4">Openness and Privacy</h2>
        <p id="open-p1" class="text-xl mb-6">Pingmark™ is designed as an <strong>Open Standard</strong>.</p>
        <div class="flex flex-col sm:flex-row justify-center gap-6">
            <div class="flex items-center justify-center font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
                <span id="open-no-tracking"><strong>No Tracking:</strong> Coordinates are not stored centrally.</span>
            </div>
            <div class="flex items-center justify-center font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5M2 6.75h3 3M7.5 9h3M9 12h3M7.5 15h3M12 9h3M13.5 12h3M12 15h3M21 12c0 2.209-1.99 4-4.444 4A4.444 4.444 0 0 1 12 12c0-2.209 1.99-4 4.444-4A4.444 4.444 0 0 1 21 12Z"/>
                </svg>
                <span id="open-source-text"><strong>Open Source:</strong> The reference code will be publicly available on GitHub.</span>
            </div>
        </div>
        <a id="github-link-button" href="https://github.com/YourGitHub/pingmark" target="_blank" class="mt-8 inline-block px-8 py-3 bg-white text-red-600 font-bold rounded-lg shadow-xl hover:bg-gray-100 transition">View Code on GitHub</a>
    </section>

    <footer class="text-center mt-16 pt-6 border-t border-gray-200 text-gray-500 text-sm">
        <p id="footer-text">&copy; 2025 Pingmark™ Protocol. Developed by Kalin Dimitrov. All rights reserved.</p>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
	const content = {
		en: {
			header_subtitle: "A Universal Textual Protocol for Spatial Mentions (PPS v0.1)",
			resolver_title: "Reference Resolver: Map Viewer",
			location_placeholder: 'To view a location, append parameters to the URL, e.g., <span class="font-mono text-sm block sm:inline font-semibold">/42.6977/23.3219</span>',
			maps_link: "Open in Google Maps",
			osrm_link: "Get Directions (OSRM)",
			explanation_p1: 'Pingmark™ defines a minimal protocol (<strong>PPS v0.1</strong>) that transforms location from a complex "feature" into a <strong>simple textual element</strong>. Similar to <code class="font-mono">@</code> for usernames and <code class="font-mono">#</code> for hashtags, <strong>!@</strong> is the universal token for physical space.',
			explanation_key: '<strong>Crucially:</strong> <strong>!@</strong> never contains coordinates. They are generated <strong>locally</strong> by your client application (e.g., keyboard or browser extension) and embedded into a standardized, open URL.',
			structure_title: "Protocol Structure (PPS v0.1)",
			flow_h3_1: "1. The Text Trigger",
			flow_p1: 'User types the trigger: <code class="font-mono font-semibold">"I am at <strong>!@</strong>"</code> in any app or text field.',
			flow_h3_2: "2. Local Coordinate Generation",
			flow_p2: "The client (L1 Parser) uses the device's GPS to silently grab <code class='font-mono font-semibold'>/Lat/Lon</code>.",
			flow_h3_3: "3. The Resolver Link",
			flow_p3: "The final, shareable, and open URL is generated: <code class='font-mono text-xs font-semibold'>pingmark.me/Lat/Lon/...</code>",
			syntax_li_1: '<code class="font-mono">latitude/longitude</code>: Generated locally by the device\'s GPS.',
			syntax_li_2: '<code class="font-mono">[timestamp]</code>: Optional (ISO 8601), indicating the ephemerality of the location.',
			open_title: "Openness and Privacy",
			open_p1: 'Pingmark™ is designed as an <strong>Open Standard</strong>.',
			open_no_tracking: '<strong>No Tracking:</strong> Coordinates are not stored centrally.',
			open_source_text: '<strong>Open Source:</strong> The reference code will be publicly available on GitHub.',
			github_link_button: "View Code on GitHub",
			footer_text: '&copy; 2025 Pingmark™ Protocol. Developed by Kalin Dimitrov. All rights reserved.',
			map_popup_title: 'Pingmark: Location',
			map_popup_coords: 'Coordinates',
			map_popup_time: 'Time',
			map_popup_time_invalid: '(Invalid Format)'
		},
		bg: {
			header_subtitle: "Универсален Текстов Протокол за Пространствени Споменавания (PPS v0.1)",
			resolver_title: "Референтен Resolver: Карта",
			location_placeholder: 'За да видите локация, добавете параметри към URL адреса, например: <span class="font-мноно text-sm block sm:inline font-semibold">/42.6977/23.3219</span>',
			maps_link: "Отвори в Google Maps",
			osrm_link: "Получи Упътвания (OSRM)",
			explanation_p1: 'Pingmark™ дефинира минимален протокол (<strong>PPS v0.1</strong>), който превръща локацията от сложна "функция" в <strong>прост текстов елемент</strong>. Подобно на <code class="font-mono">@</code> за потребителски имена и <code class="font-mono">#</code> за хаштагове, <strong>!@</strong> е универсалният токен за физическо пространство.',
			explanation_key: '<strong>Ключово:</strong> <strong>!@</strong> никога не съдържа координати. Те се генерират <strong>локално</strong> от Вашето клиентско приложение (напр. клавиатура или браузър) и се вграждат в стандартен, отворен URL.',
			structure_title: "Структура на Протокола (PPS v0.1)",
			flow_h3_1: "1. Текстов Тригер",
			flow_p1: 'Потребителят въвежда тригера: <code class="font-mono font-semibold">"Аз съм на <strong>!@</strong>"</code> във всяко приложение или текстово поле.',
			flow_h3_2: "2. Локално Генериране на Координати",
			flow_p2: "Клиентът (L1 Parser) използва GPS на устройството, за да вземе тихо <code class='font-mono font-semibold'>/Lat/Lon</code>.",
			flow_h3_3: "3. Resolver Link",
			flow_p3: "Генерира се крайният, споделяем и отворен URL: <code class='font-mono text-xs font-semibold'>pingmark.me/Lat/Lon/...</code>",
			syntax_li_1: '<code class="font-мono">latitude/longitude</code>: Генерирани локално от GPS на устройството.',
			syntax_li_2: '<code class="font-моно">[timestamp]</code>: Незадължителен (ISO 8601), указващ ефемерността на локацията.',
			open_title: "Отвореност и Поверителност",
			open_p1: 'Pingmark™ е проектиран като <strong>Отворен Стандарт</strong>.',
			open_no_tracking: '<strong>Без Проследяване:</strong> Координатите не се съхраняват централно.',
			open_source_text: '<strong>Отворен Код:</strong> Референтният код ще бъде публичен в GitHub.',
			github_link_button: "Вижте Кода в GitHub",
			footer_text: '&copy; 2025 Pingmark™ Protocol. Разработен от Kalin Dimitrov. Всички права запазени.',
			map_popup_title: 'Pingmark: Локация',
			map_popup_coords: 'Координати',
			map_popup_time: 'Време',
			map_popup_time_invalid: '(Невалиден формат)'
		}
	};

	let currentLang = 'en';

	function switchLanguage(lang) {
		currentLang = lang;
		const data = content[lang];

		document.getElementById('header-subtitle').textContent = data.header_subtitle;
		document.getElementById('resolver-title').innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-3 text-red-600">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
      </svg>${data.resolver_title}`;

		document.getElementById('location-info').innerHTML = data.location_placeholder;
		document.getElementById('maps-link').textContent = data.maps_link;
		document.getElementById('osrm-link').textContent = data.osrm_link;

		document.getElementById('explanation-p1').innerHTML = data.explanation_p1;
		document.getElementById('explanation-key').innerHTML = data.explanation_key;
		document.getElementById('structure-title').textContent = data.structure_title;

		document.getElementById('flow-h3-1').textContent = data.flow_h3_1;
		document.getElementById('flow-p1').innerHTML = data.flow_p1;
		document.getElementById('flow-h3-2').textContent = data.flow_h3_2;
		document.getElementById('flow-p2').innerHTML = data.flow_p2;
		document.getElementById('flow-h3-3').textContent = data.flow_h3_3;
		document.getElementById('flow-p3').innerHTML = data.flow_p3;

		document.getElementById('syntax-li-1').innerHTML = data.syntax_li_1;
		document.getElementById('syntax-li-2').innerHTML = data.syntax_li_2;

		document.getElementById('open-title').textContent = data.open_title;
		document.getElementById('open-p1').innerHTML = data.open_p1;
		document.getElementById('open-no-tracking').innerHTML = data.open_no_tracking;
		document.getElementById('open-source-text').innerHTML = data.open_source_text;
		document.getElementById('github-link-button').textContent = data.github_link_button;
		document.getElementById('footer-text').innerHTML = data.footer_text;

		document.getElementById('lang-en').classList.toggle('bg-red-500', lang === 'en');
		document.getElementById('lang-en').classList.toggle('text-white', lang === 'en');
		document.getElementById('lang-en').classList.toggle('border-gray-300', lang === 'bg');
		document.getElementById('lang-en').classList.toggle('text-gray-600', lang === 'bg');
		document.getElementById('lang-en').classList.toggle('border-red-500', lang === 'en');

		document.getElementById('lang-bg').classList.toggle('bg-red-500', lang === 'bg');
		document.getElementById('lang-bg').classList.toggle('text-white', lang === 'bg');
		document.getElementById('lang-bg').classList.toggle('border-gray-300', lang === 'en');
		document.getElementById('lang-bg').classList.toggle('text-gray-600', lang === 'en');
		document.getElementById('lang-bg').classList.toggle('border-red-500', lang === 'bg');

		if (marker) {
			const ll = marker.getLatLng();
			marker.setPopupContent(generatePopupContent(ll.lat, ll.lng, state.tsInput));
		}
	}

	let map = null;
	let marker = null;
	const defaultLat = 43.0768;
	const defaultLon = 25.6315;
	const defaultZoom = 13;

	function guessApiOrigin() {
		const m = location.origin.match(/:(\d+)$/);
		if (m && m[1] === '5173') return location.origin.replace(/:\d+$/, ':5175');
		return location.origin;
	}

	const API_ORIGIN = guessApiOrigin();

	const TS_ISO = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z?/;
	const TS_UNIX = /^(\d{10})(\d{3})?$/;

	function normalizeTs(ts) {
		if (!ts) return undefined;
		if (typeof ts === 'number') return Math.floor(ts);
		const s = String(ts).trim();
		if (TS_UNIX.test(s)) return s.length > 10 ? Math.floor(Number(s) / 1000) : Number(s);
		if (TS_ISO.test(s)) {
			const t = Date.parse(s);
			if (!Number.isNaN(t)) return Math.floor(t / 1000);
		}
		return undefined;
	}

	function canonicalUrl(lat, lon, tsSec) {
		const lat6 = Number(lat).toFixed(6);
		const lon6 = Number(lon).toFixed(6);
		return `/${lat6}/${lon6}${tsSec ? '/' + tsSec : ''}`;
	}

	function parsePath() {
		const parts = location.pathname.replace(/^\/+|\/+$/g, '').split('/');
		if (parts.length >= 2) {
			const lat = Number(parts[0]);
			const lon = Number(parts[1]);
			if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
				const tsInput = parts[2] ? decodeURIComponent(parts[2]) : undefined;
				const tsSec = normalizeTs(tsInput);
				return {lat, lon, tsInput, tsSec};
			}
		}
		return null;
	}

	function tsToDisplay(tsInput, tsSec) {
		let d;
		if (typeof tsSec === 'number') d = new Date(tsSec * 1000);
		else if (tsInput && TS_ISO.test(String(tsInput))) d = new Date(tsInput);
		if (d && !Number.isNaN(d.getTime())) return d.toLocaleString(currentLang === 'bg' ? 'bg-BG' : 'en-US');
		return tsInput ? `${tsInput} ${content[currentLang].map_popup_time_invalid}` : '';
	}

	function generatePopupContent(pointLat, pointLon, tsInput) {
		const data = content[currentLang];
		const parsed = state.parsed || {};
		const tsSec = parsed.tsSec;
		const when = tsToDisplay(tsInput, tsSec);
		let html = `<b>${data.map_popup_title}</b><br>${data.map_popup_coords}: ${pointLat.toFixed(6)}, ${pointLon.toFixed(6)}`;
		if (when) html += `<br>${data.map_popup_time}: ${when}`;
		return html;
	}

	function ensureMap(lat, lon, zoom = defaultZoom) {
		if (!map) {
			map = L.map('map').setView([lat, lon], zoom);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
		} else {
			map.setView([lat, lon], zoom);
			setTimeout(() => map.invalidateSize(), 0);
		}
	}

	function setMarker(lat, lon) {
		if (marker) marker.setLatLng([lat, lon]);
		else marker = L.marker([lat, lon]).addTo(map);
		marker.bindPopup(generatePopupContent(lat, lon, state.tsInput)).openPopup();
	}

	function updateExternalLinks(lat, lon) {
		const maps = document.getElementById('maps-link');
		maps.href = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
		document.getElementById('osrm-link').href = `https://router.project-osrm.org/route/v1/driving/${lon},${lat};${lon},${lat}?overview=full`;
	}

	function showActions(show) {
		document.getElementById('action-buttons').style.display = show ? 'flex' : 'none';
	}

	const state = {parsed: null, tsInput: undefined};

	async function renderFromPath() {
		const parsed = parsePath();
		state.parsed = parsed;
		state.tsInput = parsed?.tsInput;

		if (!parsed) {
			ensureMap(defaultLat, defaultLon, 10);
			showActions(false);
			document.getElementById('location-info').innerHTML = content[currentLang].location_placeholder;
			return;
		}

		const {lat, lon, tsSec, tsInput} = parsed;
		const url = canonicalUrl(lat, lon, tsSec);
		if (location.pathname !== url) history.replaceState(null, '', url);

		ensureMap(lat, lon, 15);
		setMarker(lat, lon);
		updateExternalLinks(lat, lon);
		showActions(true);

		const info = generatePopupContent(lat, lon, tsInput);
		document.getElementById('location-info').innerHTML = info;
	}

	async function resolveText() {
		const el = document.getElementById('pm-text');
		const status = document.getElementById('status');
		const q = (el.value || '').trim();
		if (!q) {
			status.textContent = 'Type/paste a pingmark first.';
			return;
		}
		status.textContent = 'Resolving...';
		try {
			const res = await fetch(`${API_ORIGIN}/api/resolve?text=${encodeURIComponent(q)}`);
			const body = await res.json().catch(() => ({}));
			if (!res.ok) {
				status.textContent = body.error || `Error ${res.status}`;
				return;
			}
			const first = body.matches?.[0];
			if (!first) {
				status.textContent = 'No pingmark found';
				return;
			}
			const next = canonicalUrl(first.lat, first.lon, first.timestamp);
			location.assign(next);
		} catch (e) {
			status.textContent = 'Network error';
		}
	}

	async function useMyLocation() {
		const status = document.getElementById('status');
		status.textContent = 'Requesting location...';
		try {
			const pos = await new Promise((resolve, reject) => {
				navigator.geolocation.getCurrentPosition(resolve, reject, {enableHighAccuracy: true, timeout: 10000});
			});
			const coords = pos.coords;
			const tsSec = Math.floor(Date.now() / 1000);
			const next = canonicalUrl(coords.latitude, coords.longitude, tsSec);
			location.assign(next);
		} catch (e) {
			status.textContent = 'Location permission denied or unavailable.';
		}
	}

	function copyShare() {
		const parsed = state.parsed;
		if (!parsed) return;
		const url = `${location.origin}${canonicalUrl(parsed.lat, parsed.lon, parsed.tsSec)}`;
		navigator.clipboard.writeText(url).then(() => {
			const s = document.getElementById('status');
			s.textContent = 'Link copied to clipboard';
			setTimeout(() => {
				if (s.textContent === 'Link copied to clipboard') s.textContent = '';
			}, 1500);
		});
	}

	document.getElementById('btn-resolve').addEventListener('click', resolveText);
	document.getElementById('pm-text').addEventListener('keydown', (e) => {
		if (e.key === 'Enter') resolveText();
	});
	document.getElementById('btn-use-location').addEventListener('click', useMyLocation);
	document.getElementById('btn-copy').addEventListener('click', copyShare);

	window.addEventListener('resize', () => {
		if (map) map.invalidateSize();
	});
	window.addEventListener('popstate', renderFromPath);

	const browserLang = (navigator.language || 'en').split('-')[0];
	switchLanguage((browserLang === 'bg' || browserLang === 'en') ? browserLang : 'en');
	renderFromPath();
</script>
</body>
</html>