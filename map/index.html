<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pingmark Map Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px 16px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .toolbar .coordinates {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: 500;
            color: #374151;
        }

        .toolbar .timestamp {
            color: #6b7280;
            font-size: 12px;
        }

        .toolbar .actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .btn-primary {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .btn-primary:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        .floating-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .floating-btn {
            padding: 12px 16px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 140px;
            text-align: center;
        }

        .floating-btn:hover {
            background: #f9fafb;
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }

        .floating-btn.primary {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .floating-btn.primary:hover {
            background: #b91c1c;
        }

        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .error h1 {
            color: #dc2626;
            margin-bottom: 8px;
        }

        .error p {
            color: #6b7280;
            margin-bottom: 16px;
        }

        .error .btn {
            display: inline-block;
        }

        @media (max-width: 640px) {
            .toolbar {
                padding: 8px 12px;
                font-size: 12px;
            }

            .toolbar .coordinates {
                font-size: 11px;
            }

            .floating-actions {
                bottom: 16px;
                right: 16px;
            }

            .floating-btn {
                padding: 10px 12px;
                font-size: 12px;
                min-width: 120px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Content will be rendered here -->
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Utility functions
        function parsePath(pathname) {
            const parts = pathname.replace(/^\/+|\/+$/g, '').split('/');
            if (parts.length >= 2) {
                const lat = Number(parts[0]);
                const lon = Number(parts[1]);
                if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
                    const timestamp = parts[2] ? Number(parts[2]) : undefined;
                    return { lat, lon, timestamp };
                }
            }
            return null;
        }

        function canonicalUrl(lat, lon, timestamp) {
            const lat6 = Number(lat).toFixed(6);
            const lon6 = Number(lon).toFixed(6);
            return `/${lat6}/${lon6}${timestamp ? `/${timestamp}` : ''}`;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch {
                return false;
            }
        }

        // Map Viewer App
        class MapViewerApp {
            constructor() {
                this.map = null;
                this.marker = null;
                this.currentLocation = null;
                this.init();
            }

            init() {
                // Parse URL to get coordinates
                const location = parsePath(window.location.pathname);

                if (!location) {
                    this.showError();
                    return;
                }

                this.currentLocation = location;
                this.render();
            }

            showError() {
                const app = document.getElementById('app');
                app.innerHTML = `
          <div class="error">
            <h1>Invalid Location</h1>
            <p>Please provide valid coordinates in the URL format:</p>
            <p><code>/latitude/longitude[/timestamp]</code></p>
            <a href="https://pingmark.me" class="btn btn-primary">Go to Pingmark</a>
          </div>
        `;
            }

            render() {
                if (!this.currentLocation) return;

                const { lat, lon, timestamp } = this.currentLocation;
                const app = document.getElementById('app');

                app.innerHTML = `
          <div id="toolbar"></div>
          <div id="map"></div>
          <div id="floating-actions"></div>
        `;

                // Initialize components
                this.initToolbar(lat, lon, timestamp);
                this.initMap(lat, lon, timestamp);
                this.renderFloatingActions();
            }

            initToolbar(lat, lon, timestamp) {
                const toolbar = document.getElementById('toolbar');
                const timestampText = timestamp
                    ? new Date(timestamp * 1000).toLocaleString()
                    : '';

                toolbar.innerHTML = `
          <div class="coordinates">
            ${lat.toFixed(6)}, ${lon.toFixed(6)}
          </div>
          ${timestampText ? `<div class="timestamp">${timestampText}</div>` : ''}
          <div class="actions">
            <button class="btn" id="copy-btn">Copy Link</button>
            <button class="btn" id="share-btn">Share</button>
          </div>
        `;

                // Add event listeners
                document.getElementById('copy-btn').addEventListener('click', () => this.copyLink());
                document.getElementById('share-btn').addEventListener('click', () => this.shareLink());
            }

            initMap(lat, lon, timestamp) {
                // Initialize map
                this.map = L.map('map', {
                    zoomControl: true,
                    attributionControl: true
                }).setView([lat, lon], 15);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map);

                // Custom Pingmark icon
                const pingIcon = L.icon({
                    iconUrl: 'images/pingmark_logo_icon.png',
                    iconSize: [36, 44],
                    iconAnchor: [18, 44],
                    popupAnchor: [0, -44]
                });

                // Add marker
                this.marker = L.marker([lat, lon], { icon: pingIcon }).addTo(this.map);

                // Create popup content
                const popupContent = this.createPopupContent(lat, lon, timestamp);
                this.marker.bindPopup(popupContent).openPopup();

                // Handle window resize
                window.addEventListener('resize', () => {
                    setTimeout(() => this.map.invalidateSize(), 0);
                });
            }

            createPopupContent(lat, lon, timestamp) {
                let content = `
          <div style="text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
            <div style="font-weight: 600; color: #dc2626; margin-bottom: 8px;">
              üìç Pingmark Location
            </div>
            <div style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; color: #374151;">
              ${lat.toFixed(6)}, ${lon.toFixed(6)}
            </div>
        `;

                if (timestamp) {
                    const date = new Date(timestamp * 1000);
                    if (!isNaN(date.getTime())) {
                        content += `
              <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                ${date.toLocaleString()}
              </div>
            `;
                    }
                }

                content += `</div>`;
                return content;
            }

            renderFloatingActions() {
                if (!this.currentLocation) return;

                const { lat, lon } = this.currentLocation;
                const floatingActions = document.getElementById('floating-actions');

                floatingActions.innerHTML = `
          <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" 
             target="_blank" 
             class="floating-btn primary">
            Open in Google Maps
          </a>
          <a href="https://router.project-osrm.org/route/v1/driving/${lon},${lat};${lon},${lat}?overview=full" 
             target="_blank" 
             class="floating-btn">
            Get Directions
          </a>
        `;
            }

            async copyLink() {
                if (!this.currentLocation) return;

                const { lat, lon, timestamp } = this.currentLocation;
                const url = `https://map.pingmark.me${canonicalUrl(lat, lon, timestamp)}`;

                const success = await copyToClipboard(url);
                if (success) {
                    this.showCopySuccess();
                } else {
                    this.showCopyError();
                }
            }

            async shareLink() {
                if (!this.currentLocation) return;

                const { lat, lon, timestamp } = this.currentLocation;
                const url = `https://map.pingmark.me${canonicalUrl(lat, lon, timestamp)}`;

                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Pingmark Location',
                            text: `Check out this location: ${lat.toFixed(6)}, ${lon.toFixed(6)}`,
                            url: url
                        });
                    } catch (error) {
                        // User cancelled or error occurred
                        this.copyLink();
                    }
                } else {
                    // Fallback to copy
                    this.copyLink();
                }
            }

            showCopySuccess() {
                const btn = document.getElementById('copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#10b981';
                btn.style.color = 'white';
                btn.style.borderColor = '#10b981';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }, 2000);
            }

            showCopyError() {
                const btn = document.getElementById('copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Error';
                btn.style.background = '#ef4444';
                btn.style.color = 'white';
                btn.style.borderColor = '#ef4444';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.style.borderColor = '';
                }, 2000);
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new MapViewerApp();
        });
    </script>
</body>

</html>